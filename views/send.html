<h1>Send a message</h1>
<br />

<div id="ContactMessageSentAlert" class="alert alert-success">
	Your message has been sent.  
	To view responses to this message you will need the following code:
	<span id="PostID"></span>
</div>

<div id="UserUnsubscribedAlert" class="alert alert-warning">
	The recipient has unsubscribed from all messages from this service.   You can not send messages to this recipient.
</div>

<form role="form" id="ContactMessageForm">
	<div class="form-group row">
    	<label for="ToEmailAddress" class="sr-only legacy-label">Recipient's Email Address</label>
		<input type="email" id="ToEmailAddress" name="ToEmailAddress" maxlength="255" class="form-control" placeholder="Recipient's Email Address" />
	</div>
	<div class="form-group row">
		<label for="Subject" class="sr-only legacy-label">Subject</label>
		<input type="text" id="Subject" name="Subject" maxlength="255" class="form-control" placeholder="Subject" />
	</div>
	<div class="form-group row">
		<label for="Message" class="sr-only legacy-label">Message</label>
		<textarea id="Message" name="Message" rows="5" class="form-control" placeholder="Message"></textarea>
	</div>
	<div class="form-group row">
		<input type="checkbox" id="ReceiveEmailNotification" name="ReceiveEmailNotification" />
		<label for="ReceiveEmailNotification">Yes, I would like to receive an email notification if the user responds to my message.</label>
	</div>
	<div class="form-group row" id="FromEmailAddressRow">
		<label for="FromEmailAddress" class="sr-only legacy-label">Your Email Address</label>
		<input type="email" id="FromEmailAddress" name="FromEmailAddress" maxlength="255" class="form-control" placeholder="Your Email Address" />
	</div>
	<div class="form-group row" id="CaptchaRow">
		<div class="col-xs-6 col-md-3 no-padding">
			<canvas id="CaptchaCanvas" class="captcha-canvas" />
		</div>
		<div class="col-xs-12 col-md-9 no-padding">
			<input type="text" id="Captcha" name="Captcha" maxlength="6" class="form-control" placeholder="Type the code displayed in the image." />
		</div>
	</div>
	<div class="form-group row">
		<input type="hidden" id="PostIDHidden" />
		<button type="button" class="btn btn-default" id="ContactMessageSendButton">Send</button>
	</div>
</form>
<div id="dataPlaceholder"></div>

<script type="text/javascript" src="/scripts/mail.js" defer="defer"></script>
<script type="text/javascript" src="/scripts/captcha.min.js" defer="defer"></script>
<script type="text/javascript">
	$(document).ready(function () { 
		// Set initial state of form...
		$('#ContactMessageSentAlert').hide();
		$('#UserUnsubscribedAlert').hide();
		$('#ContactMessageForm').show();
		$('#FromEmailAddressRow').hide();
		
		// Create this post's GUID...
		var uuid = generateUUID();
		$('#PostIDHidden').val(uuid);
		$('#PostID').html(uuid);
		
		// Toggle visibility of "From" email address row...
		$('#ReceiveEmailNotification').click(function(){
			var isEmailNotificationChecked = this.checked;
			if(isEmailNotificationChecked == true) {
				$('#FromEmailAddressRow').show();
			}
			else {
				$('#FromEmailAddressRow').hide();	
			}
		});
		
		// Toggle unsubscribed message based on recipient's email address...
		$('#ToEmailAddress').blur(function() {
			$('#dataPlaceholder').sheetrock({
	  			url: unsubscribeDatasource,
	  			sql: "select B where B = '" + $("#ToEmailAddress").val() + "'",
				formatting: false,
	  			dataHandler: isUserUnsubscribed
			});
		
			function isUserUnsubscribed(data)
			{
				//$('#dataPlaceholder').html('<pre>' + JSON.stringify(data) + '</pre>');
				if (data.table.rows[0] !== undefined) {
					$('#UserUnsubscribedAlert').show();
					$('#ContactMessageSendButton').attr("disabled", "disabled");
					// console.log("Unsubscribed: true");
				}
				else {
					$('#UserUnsubscribedAlert').hide();
					$('#ContactMessageSendButton').removeAttr("disabled");
					// console.log("Unsubscribed: false");
				}
			}
		});
		
		// Toggle visibility of "CAPTCHA" row...
		if ($.cookie('ClearedCaptcha') !== undefined)
		{
			$('#CaptchaRow').hide();	
		}
		var securityCode = GenerateCaptcha('CaptchaCanvas');
		
		// Setup form field validation...
		var validator = $('#ContactMessageForm').validate({
			errorElement: 'div',
			rules: {
				ToEmailAddress: {required: true, email: true},
				Subject: {required: true},
				Message: {required: true},
				Captcha: {required: true, captcha: securityCode},
				FromEmailAddress: {required: true, email: true}
			},
			messages: {
				ToEmailAddress: {required: 'Please enter the recipient\'s email address.', email: 'Please enter a valid email address.'},
				Subject: {required: 'Please enter a subject.'},
				Message: {required: 'Please enter a message.'},
				Captcha: {required: 'Please type the code displayed in the image.', captcha: 'The code you typed did not match the image displayed.'},
				FromEmailAddress: {required: 'You have indicated that you would like to receive an email notification if the recipient responds to your message.   Please enter your email address.', email: 'Please enter a valid email address.'}
			},
			errorPlacement: function (error, element) {
				$(error).insertBefore($(element));
			},
			highlight: function(element, errorClass) {				
				$(element).parent('div').addClass('has-error');
			},			
			unhighlight: function(element, errorClass, validClass) {
				$(element).parent('div').removeClass('has-error');
			},
			onfocusout: false,
			invalidHandler: function(event, validator){
				setTimeout(function(){
					$('input:text').blur();
					$('textarea').blur();
					// Pseudo of input:email is not recognized by jQuery yet, so have to target the email fields individually.
					$('#EmailAddress').blur();
				}, 10);
			}
		});		
	});
</script>
