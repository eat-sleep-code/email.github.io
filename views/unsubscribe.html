<h1>Unsubscribe</h1>
<br />



<div id="UserUnsubscribedAlert" class="alert alert-warning">
	This email address has been unsubscribed from this service.   Thank you.
</div>

<form role="form" id="UnsubscribeForm">
		<label for="ToEmailAddress" class="sr-only legacy-label">Your Email Address</label>
		<input type="email" id="ToEmailAddress" name="ToEmailAddress" maxlength="255" class="form-control" placeholder="Your Email Address" />
</form>
<div id="dataPlaceholder"></div>

<script type="text/javascript">
	$(document).ready(function () { 
		// Set initial state of form...
		$('#UserUnsubscribedAlert').hide();
		$('#UnsubscribeForm').show();
		
		// Toggle already unsubscribed message based on recipient's email address...
		$('#ToEmailAddress').blur(function() {
			$('#dataPlaceholder').sheetrock({
	  			url: unsubscribeDatasource,
	  			sql: "select B where B = '" + $("#ToEmailAddress").val() + "'",
				formatting: false,
	  			dataHandler: isUserUnsubscribed
			});
		
			function isUserUnsubscribed(data)
			{
				//$('#dataPlaceholder').html('<pre>' + JSON.stringify(data) + '</pre>');
				if (data.table.rows[0] !== undefined) {
					$('#UserUnsubscribedAlert').show();
					$('#UnsubscribeButton').attr("disabled", "disabled");
					// console.log("Unsubscribed: true");
				}
				else {
					$('#UserUnsubscribedAlert').hide();
					$('#UnsubscribeButton').removeAttr("disabled");
					// console.log("Unsubscribed: false");
				}
			}
		});
		
		
		// Setup form field validation...
		var validator = $('#UnsubscribeForm').validate({
			errorElement: 'div',
			rules: {
				ToEmailAddress: {required: true, email: true}
			},
			messages: {
				ToEmailAddress: {required: 'Please enter your email address.', email: 'Please enter a valid email address.'},
			},
			errorPlacement: function (error, element) {
				$(error).insertBefore($(element));
			},
			highlight: function(element, errorClass) {				
				$(element).parent('div').addClass('has-error');
			},			
			unhighlight: function(element, errorClass, validClass) {
				$(element).parent('div').removeClass('has-error');
			},
			onfocusout: false,
			invalidHandler: function(event, validator){
				setTimeout(function(){
					$('input:text').blur();
					$('textarea').blur();
					// Pseudo of input:email is not recognized by jQuery yet, so have to target the email fields individually.
					$('#EmailAddress').blur();
				}, 10);
			}
		});
	});
</script>
